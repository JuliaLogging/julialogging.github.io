<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>How to rotate log files · JuliaLogging</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/julialogging.css" rel="stylesheet" type="text/css"/><link href="../../assets/gruvbox-light-hard.css" rel="stylesheet" type="text/css"/><link href="../../assets/gruvbox-dark-hard.css" rel="stylesheet" type="text/css"/><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="JuliaLogging logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">JuliaLogging</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../package-overview/">Logging package overview</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/logging-basics/">Logging basics</a></li><li><a class="tocitem" href="../../tutorials/working-with-loggers/">Working with loggers</a></li><li><a class="tocitem" href="../../tutorials/implement-a-new-logger/">Implement a new logger</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">How-to guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../enable-debug/">How to enable <code>@debug</code> messages</a></li><li><a class="tocitem" href="../log-to-file/">How to log to a file</a></li><li><a class="tocitem" href="../tee/">Send messages to multiple locations</a></li><li><a class="tocitem" href="../filter-messages/">How to filter messages</a></li><li class="is-active"><a class="tocitem" href>How to rotate log files</a><ul class="internal"><li><a class="tocitem" href="#Date-based-log-rotation"><span>Date based log rotation</span></a></li><li><a class="tocitem" href="#Filesize-based-log-rotation"><span>Filesize based log rotation</span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Reference</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../reference/logcompose/">LogCompose.jl</a></li><li><a class="tocitem" href="../../reference/logging/">Logging.jl</a></li><li><a class="tocitem" href="../../reference/logging2/">Logging2.jl</a></li><li><a class="tocitem" href="../../reference/loggingextras/">LoggingExtras.jl</a></li><li><a class="tocitem" href="../../reference/loggingformats/">LoggingFormats.jl</a></li><li><a class="tocitem" href="../../reference/logroller/">LogRoller.jl</a></li><li><a class="tocitem" href="../../reference/lokilogger/">LokiLogger.jl</a></li><li><a class="tocitem" href="../../reference/progresslogging/">ProgressLogging.jl</a></li><li><a class="tocitem" href="../../reference/sysloglogging/">SyslogLogging.jl</a></li><li><a class="tocitem" href="../../reference/terminalloggers/">TerminalLoggers.jl</a></li><li><a class="tocitem" href="../../reference/miniloggers/">MiniLoggers.jl</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How-to guides</a></li><li class="is-active"><a href>How to rotate log files</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>How to rotate log files</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaLogging/julialogging.github.io/blob/master/src/how-to/rotate-log-files.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="How-to-rotate-log-files"><a class="docs-heading-anchor" href="#How-to-rotate-log-files">How to rotate log files</a><a id="How-to-rotate-log-files-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-rotate-log-files" title="Permalink"></a></h1><p><em>Log rotation</em> is common for long running applications such as e.g. a webserver, see for example <a href="https://linux.die.net/man/8/logrotate"><code>logrotate</code></a> for Linux systems. Log rotation means that the logfile is swapped according to some criterion. Usually a logfile is rotated based on the date, for example daily or weekly, or based on file size, for example to keep the individual files below 10MB.</p><h2 id="Date-based-log-rotation"><a class="docs-heading-anchor" href="#Date-based-log-rotation">Date based log rotation</a><a id="Date-based-log-rotation-1"></a><a class="docs-heading-anchor-permalink" href="#Date-based-log-rotation" title="Permalink"></a></h2><p>The <a href="../../reference/loggingextras/#LoggingExtras.jl">LoggingExtras.jl</a> package implements the <a href="../../reference/loggingextras/#LoggingExtras.DatetimeRotatingFileLogger"><code>DatetimeRotatingFileLogger</code></a> which, as the name suggests, is a logger for date/time based log rotation. The frequency of log rotation is determined based on the input filename patterin in the form of a dateformat (see documentation for <a href="https://docs.julialang.org/en/v1/stdlib/Dates/#Dates.DateFormat"><code>Dates.DateFormat</code></a> and <a href="https://docs.julialang.org/en/v1/stdlib/Dates/#Dates.@dateformat_str"><code>dateformat&quot;...&quot;</code></a>).</p><p>Let&#39;s look at an initial example:</p><pre><code class="language-julia hljs"><span class="hljs-keyword">using</span> Logging, LoggingExtras

<span class="hljs-comment"># Directory for our log files</span>
logdir <span class="hljs-keyword">=</span> <span class="hljs-built_in">joinpath</span>(<span class="hljs-meta">@__DIR__</span>, <span class="hljs-string">&quot;logs&quot;</span>)
<span class="hljs-built_in">mkpath</span>(logdir)

<span class="hljs-comment"># Filename pattern (see note below about character escaping)</span>
filename_pattern <span class="hljs-keyword">=</span> <span class="hljs-string">raw&quot;yyyy-mm-dd-\w\e\b\s\e\r\v\e\r.\l\o\g&quot;</span>

<span class="hljs-comment"># Create the logger</span>
logger <span class="hljs-keyword">=</span> <span class="hljs-built_in">DatetimeRotatingFileLogger</span>(logdir, filename_pattern)

<span class="hljs-comment"># Install the logger globally</span>
<span class="hljs-built_in">global_logger</span>(logger)
</code></pre><p>This is a logger that will rotate the log file every day, since &quot;day&quot; is the smallest datetime unit in the filaname pattern.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Note that all characters in the filename pattern that should not be part of of the datetime pattern are escaped. Without this these characters would also be interpreted by <a href="https://docs.julialang.org/en/v1/stdlib/Dates/#Dates.DateFormat"><code>Dates.DateFormat</code></a>. Technically not all characters need to be escaped, for example <code>w</code> doesn&#39;t have a meaning, but it is safest to escape all characters like in the example above.</p></div></div><p>Eventually, after some days of logging, we would end up with the following files in our log directory:</p><pre><code class="language-bash hljs">$ ls logs/
2021-11-12-webserver.log
2021-11-13-webserver.log
2021-11-14-webserver.log
2021-11-15-webserver.log</code></pre><hr/><p>Let&#39;s now improve the logger by adding two features that are commonly used in <code>logrotate</code>: file compression and file retention policy. Log files are usually quite compressable and adding compression could save us some space. A file retention policy let us keep log files for a fixed number of days, for example 30, and then automatically delete them. Support for compression and retention policies are not built-in, but there are external packages that we can use for these purposes and implement this functionality in a callback function using the <code>rotation_callback</code> keyword argument. The <code>DatetimeRotatingFileLogger</code> calls this function every time it rotates the log file. The only argument to the function is the &quot;old&quot; file.</p><p>For compression we will use <code>gzip</code>, through <code>Gzip_jll</code>:</p><pre><code class="language-julia hljs"><span class="hljs-keyword">using</span> Gzip_jll

<span class="hljs-keyword">function </span><span class="hljs-title">logger_callback</span>(<span class="hljs-params">file</span>)
    <span class="hljs-comment"># Compress the file</span>
    Gzip_jll<span class="hljs-built_in">.</span><span class="hljs-built_in">gzip</span>() <span class="hljs-keyword">do</span> gzip
        <span class="hljs-built_in">run</span>(<span class="hljs-string">`<span class="hljs-subst">$(gzip)</span> <span class="hljs-subst">$(file)</span>`</span>)
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre><p>For the file retention policy we will use an <code>NFileCache</code> from the <a href="https://github.com/staticfloat/FilesystemDatastructures.jl">FilesystemDatastructures</a> package. Here we create a file cache that keeps 30 files:</p><pre><code class="language-julia hljs"><span class="hljs-keyword">using</span> FilesystemDatastructures

<span class="hljs-comment"># Create a file cache that keeps 30 files</span>
fc <span class="hljs-keyword">=</span> <span class="hljs-built_in">NFileCache</span>(logdir, <span class="hljs-number">30</span>, <span class="hljs-built_in">DiscardLRU</span>();
                <span class="hljs-comment"># Make sure only files ending with &quot;webserver.log.gz&quot; are included</span>
                predicate <span class="hljs-keyword">=</span> x <span class="hljs-built_in">-&gt;</span> <span class="hljs-built_in">endswith</span>(x, <span class="hljs-regexp">r&quot;webserver\.log\.gz&quot;</span>)
)
</code></pre><p>Now we just have to modify the callback above to add rotated and compressed files to the cache:</p><pre><code class="language-julia hljs"><span class="hljs-keyword">function </span><span class="hljs-title">logger_callback</span>(<span class="hljs-params">file</span>)
    <span class="hljs-comment"># Compress the file</span>
    Gzip_jll<span class="hljs-built_in">.</span><span class="hljs-built_in">gzip</span>() <span class="hljs-keyword">do</span> gzip
        <span class="hljs-built_in">run</span>(<span class="hljs-string">`<span class="hljs-subst">$(gzip)</span> <span class="hljs-subst">$(file)</span>`</span>)
    <span class="hljs-keyword">end</span>
    <span class="hljs-comment"># Add the compressed file to the cache (gzip adds the .gz extension)</span>
    FilesystemDatastructures<span class="hljs-built_in">.</span><span class="hljs-built_in">add!</span>(fc, file <span class="hljs-built_in">*</span> <span class="hljs-string">&quot;.gz&quot;</span>)
<span class="hljs-keyword">end</span>
</code></pre><p>When the 31th file is added to the cache the oldest file will automatically be deleted to make room for the new file. Inspecting the log directory after letting the application run for some time gives us:</p><pre><code class="language-bash hljs">$ ls logs/
2021-11-20-webserver.log.gz
2021-11-21-webserver.log.gz
2021-11-22-webserver.log.gz
[...]
2021-12-17-webserver.log.gz
2021-12-18-webserver.log.gz
2021-12-19-webserver.log.gz
2021-12-20-webserver.log</code></pre><p>30 compressed files, managed by the cache, and one &quot;active&quot; file yet to be compressed and added to the cache.</p><hr/><p>Here is the complete example:</p><pre><code class="language-julia hljs"><span class="hljs-keyword">using</span> Logging, LoggingExtras, Gzip_jll, FilesystemDatastructures

<span class="hljs-comment"># Directory for our log files</span>
logdir <span class="hljs-keyword">=</span> <span class="hljs-built_in">joinpath</span>(<span class="hljs-meta">@__DIR__</span>, <span class="hljs-string">&quot;logs&quot;</span>)
<span class="hljs-built_in">mkpath</span>(logdir)

<span class="hljs-comment"># Filename pattern</span>
filename_pattern <span class="hljs-keyword">=</span> <span class="hljs-string">raw&quot;yyyy-mm-dd-\w\e\b\s\e\r\v\e\r.\l\o\g&quot;</span>

<span class="hljs-comment"># File cache that keeps 30 files</span>
fc <span class="hljs-keyword">=</span> <span class="hljs-built_in">NFileCache</span>(logdir, <span class="hljs-number">30</span>, <span class="hljs-built_in">DiscardLRU</span>();
                <span class="hljs-comment"># Make sure only files ending with &quot;webserver.log.gz&quot; are included</span>
                predicate <span class="hljs-keyword">=</span> x <span class="hljs-built_in">-&gt;</span> <span class="hljs-built_in">endswith</span>(x, <span class="hljs-regexp">r&quot;webserver\.log\.gz&quot;</span>)
)

<span class="hljs-comment"># Callback function for compression and adding to cache</span>
<span class="hljs-keyword">function </span><span class="hljs-title">logger_callback</span>(<span class="hljs-params">file</span>)
    <span class="hljs-comment"># Compress the file</span>
    Gzip_jll<span class="hljs-built_in">.</span><span class="hljs-built_in">gzip</span>() <span class="hljs-keyword">do</span> gzip
        <span class="hljs-built_in">run</span>(<span class="hljs-string">`<span class="hljs-subst">$(gzip)</span> <span class="hljs-subst">$(file)</span>`</span>)
    <span class="hljs-keyword">end</span>
    <span class="hljs-comment"># Add the compressed file to the cache (gzip adds the .gz extension)</span>
    FilesystemDatastructures<span class="hljs-built_in">.</span><span class="hljs-built_in">add!</span>(fc, file <span class="hljs-built_in">*</span> <span class="hljs-string">&quot;.gz&quot;</span>)
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># Create the logger</span>
logger <span class="hljs-keyword">=</span> <span class="hljs-built_in">DatetimeRotatingFileLogger</span>(
             logdir, filename_pattern;
             rotation_callback <span class="hljs-keyword">=</span> logger_callback,
)

<span class="hljs-comment"># Install the logger globally</span>
<span class="hljs-built_in">global_logger</span>(logger)
</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The setup above is very similar to the logging setup used by Julia&#39;s package servers, see <a href="https://github.com/JuliaPackaging/PkgServer.jl/blob/72e3f280ac0f91d9ded17f23920f0aa3e2a28a89/bin/run_server.jl#L24-L53">JuliaPackaging/PkgServer.jl:bin/run_server.jl</a></p></div></div><h2 id="Filesize-based-log-rotation"><a class="docs-heading-anchor" href="#Filesize-based-log-rotation">Filesize based log rotation</a><a id="Filesize-based-log-rotation-1"></a><a class="docs-heading-anchor-permalink" href="#Filesize-based-log-rotation" title="Permalink"></a></h2><p>For filesize based rotation, e.g. file rotation when the filesize reaches a specific threshold, checkout the <a href="../../reference/logroller/#LogRoller.jl">LogRoller.jl</a> package.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../filter-messages/">« How to filter messages</a><a class="docs-footer-nextpage" href="../../reference/logcompose/">LogCompose.jl »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.14 on <span class="colophon-date" title="Friday 11 March 2022 01:37">Friday 11 March 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
